name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - stage
          - production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [stage, production]
      fail-fast: false
    
    # Skip job if workflow_dispatch specified a specific environment
    name: Deploy ${{ matrix.environment }}
    if: |
      github.event_name == 'push' || 
      github.event.inputs.environment == 'all' || 
      github.event.inputs.environment == matrix.environment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for ${{ matrix.environment }}
        run: |
          docker build \
            --build-arg APP_ENV=${{ matrix.environment }} \
            -t chatbot-faq:${{ matrix.environment }} \
            -t chatbot-faq:${{ matrix.environment }}-${{ github.sha }} \
            .

      # Option 1: Deploy using Docker Hub (recommended for free tier)
      # Uncomment and configure if using Docker Hub
      #
      # - name: Log in to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      #
      # - name: Push Docker image to Docker Hub
      #   run: |
      #     docker tag chatbot-faq:${{ matrix.environment }}-${{ github.sha }} \
      #       ${{ secrets.DOCKER_USERNAME }}/chatbot-faq:${{ matrix.environment }}-${{ github.sha }}
      #     docker tag chatbot-faq:${{ matrix.environment }} \
      #       ${{ secrets.DOCKER_USERNAME }}/chatbot-faq:${{ matrix.environment }}
      #     docker push ${{ secrets.DOCKER_USERNAME }}/chatbot-faq:${{ matrix.environment }}-${{ github.sha }}
      #     docker push ${{ secrets.DOCKER_USERNAME }}/chatbot-faq:${{ matrix.environment }}
      #
      # - name: Deploy to Azure Web App (${{ matrix.environment }}) from Docker Hub
      #   uses: azure/webapps-deploy@v2
      #   with:
      #     app-name: ${{ secrets[format('AZURE_WEBAPP_NAME_{0}', matrix.environment)] }}
      #     publish-profile: ${{ secrets[format('AZURE_WEBAPP_PUBLISH_PROFILE_{0}', matrix.environment)] }}
      #     images: ${{ secrets.DOCKER_USERNAME }}/chatbot-faq:${{ matrix.environment }}

      # Option 2: Deploy directly using publish profile (simple approach)
      - name: Deploy to Azure Web App (${{ matrix.environment }})
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets[format('AZURE_WEBAPP_NAME_{0}', matrix.environment)] }}
          publish-profile: ${{ secrets[format('AZURE_WEBAPP_PUBLISH_PROFILE_{0}', matrix.environment)] }}
          package: .

      # Note: After deployment, set APP_ENV in Azure Portal:
      # Go to App Service > Configuration > Application settings
      # Add: APP_ENV = ${{ matrix.environment }}

