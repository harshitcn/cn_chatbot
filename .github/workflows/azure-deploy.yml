name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: cn-chatbot-app-avgchjh7bhckhycn  # Update with your actual Azure App Service name
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python version
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Prepare deployment package
      run: |
        echo "Cleaning up unnecessary files..."
        # Remove Python cache files
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -type f -name "*.pyc" -delete 2>/dev/null || true
        find . -type f -name "*.pyo" -delete 2>/dev/null || true
        find . -type f -name "*.pyd" -delete 2>/dev/null || true
        # Remove Git files
        rm -rf .git 2>/dev/null || true
        # Remove virtual environments
        rm -rf .venv venv ENV 2>/dev/null || true
        # Remove cache directories
        rm -rf .cache .pytest_cache .mypy_cache 2>/dev/null || true
        # Remove IDE files
        rm -rf .vscode .idea 2>/dev/null || true
        # Remove OS files
        find . -name ".DS_Store" -delete 2>/dev/null || true
        find . -name "Thumbs.db" -delete 2>/dev/null || true
        # Remove log files
        find . -name "*.log" -delete 2>/dev/null || true
        echo "Cleanup complete!"

    - name: Create deployment package
      run: |
        echo "Creating deployment zip package..."
        zip -r deploy.zip . \
          -x "*.git*" \
          -x "*__pycache__*" \
          -x "*.pyc" \
          -x "*.pyo" \
          -x "*.pyd" \
          -x ".venv/*" \
          -x "venv/*" \
          -x "ENV/*" \
          -x ".cache/*" \
          -x ".pytest_cache/*" \
          -x ".mypy_cache/*" \
          -x "*.log" \
          -x ".DS_Store" \
          -x "Thumbs.db" \
          -x ".vscode/*" \
          -x ".idea/*" \
          -x "data/vector_*.faiss/*" || true
        echo "Package created: $(du -h deploy.zip | cut -f1)"

    - name: Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deploy.zip
        startup-command: 'python -m uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1'

